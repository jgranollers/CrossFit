<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detall Usuari - PateixFit</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
</head>
<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <aside class="sidebar col-auto">
            <div class="sidebar-title">
                <i class="fas fa-dumbbell"></i>
                PateixFit
            </div>
            <nav class="sidebar-section">
                <a href="/competiciones" class="sidebar-link">
                    <i class="fas fa-trophy"></i> Competicions
                </a>
                <a href="/concursants" class="sidebar-link">
                    <i class="fas fa-users"></i> Concursants
                </a>
                <a href="/resultats" class="sidebar-link">
                    <i class="fas fa-chart-bar"></i> Resultats Competicions
                </a>
                <a href="/usuaris" class="sidebar-link active">
                    <i class="fas fa-shield-alt"></i> Gestió Usuaris
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content flex-grow-1">
            <!-- Top Bar -->
            <div class="top-bar mb-4">
                <div class="search-box">
                    <input type="text" placeholder="Buscar">
                    <button type="submit"><i class="fas fa-search"></i></button>
                </div>
                <div class="profile-section">
                    <img th:if="${currentUserNacionalitat != null and !currentUserNacionalitat.isEmpty()}"
                         th:src="'https://flagcdn.com/24x18/' + ${#strings.toLowerCase(currentUserNacionalitat)} + '.png'"
                         th:alt="${currentUserNacionalitat}" width="28" height="21"
                         style="border-radius: 2px; vertical-align: middle; box-shadow: 0 1px 3px rgba(0,0,0,0.4);">
                    <a href="/perfil" class="avatar" title="Anar al perfil" style="display:flex;align-items:center;justify-content:center;text-decoration:none;overflow:hidden;">
                        <img th:if="${currentUserFoto != null}" th:src="${currentUserFoto}" alt="Foto" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
                        <i th:unless="${currentUserFoto != null}" class="fas fa-user" style="font-size:1.2rem; color: var(--accent-green);"></i>
                    </a>
                    <a href="/perfil" class="btn-profile">Perfil</a>
                </div>
            </div>

            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title" th:text="${usuari.nom}">Nom Usuari</h1>
                <div>
                    <a th:href="@{'/usuaris/editar/' + ${usuari.dni}}" class="btn btn-secondary me-2">
                        <i class="fas fa-edit"></i> Editar
                    </a>
                    <form th:action="@{'/usuaris/' + ${usuari.dni} + '/eliminar'}" method="post" style="display:inline;"
                          onsubmit="return confirm('Eliminar aquest usuari?')">
                        <button type="submit" class="btn btn-danger me-2"><i class="fas fa-trash"></i> Eliminar</button>
                    </form>
                    <a href="/usuaris" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Tornar</a>
                </div>
            </div>

            <!-- Detail Container -->
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card" style="background-color:var(--card-dark);border:1px solid var(--border-dark);margin-bottom:2rem;">
                            <div class="card-body p-4">
                                <div style="display:flex;align-items:flex-start;gap:2rem;margin-bottom:2rem;">
                                    <!-- Avatar -->
                                    <div style="width:80px;height:80px;border-radius:50%;background:rgba(99,102,241,0.15);border:2px solid rgba(99,102,241,0.3);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;">
                                        <img th:if="${usuari.fotoPerfilPath != null}"
                                             th:src="'/uploads/' + ${usuari.fotoPerfilPath}"
                                             style="width:100%;height:100%;object-fit:cover;" alt="foto">
                                        <i th:unless="${usuari.fotoPerfilPath != null}" class="fas fa-user fa-2x" style="color:var(--accent-green);"></i>
                                    </div>
                                    <div>
                                        <h2 style="color:var(--text-light);margin-bottom:0.3rem;" th:text="${usuari.nom}"></h2>
                                        <span class="card-badge" th:classappend="${usuari.rol == 'ADMIN'} ? ' badge-blue' : ' badge-green'"
                                              th:text="${usuari.rol ?: 'USUARI'}"></span>
                                        <div th:if="${usuari.nacionalitat != null}" style="margin-top:0.5rem;">
                                            <img th:src="'https://flagcdn.com/28x21/' + ${#strings.toLowerCase(usuari.nacionalitat)} + '.png'"
                                                 th:alt="${usuari.nacionalitat}" width="28" height="21"
                                                 style="border-radius:2px;box-shadow:0 1px 3px rgba(0,0,0,0.4);">
                                        </div>
                                    </div>
                                </div>

                                <h3 class="mb-3" style="font-size:1rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.06em;">Informació Personal</h3>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <i class="fas fa-id-card fa-lg me-3"></i>
                                            <div><div class="info-label">DNI</div><div class="info-value" th:text="${usuari.dni}"></div></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <i class="fas fa-envelope fa-lg me-3"></i>
                                            <div><div class="info-label">Correu</div><div class="info-value" th:text="${usuari.correu ?: '-'}"></div></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <i class="fas fa-phone fa-lg me-3"></i>
                                            <div><div class="info-label">Telèfon</div><div class="info-value" th:text="${usuari.telefon ?: '-'}"></div></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <i class="fas fa-flag fa-lg me-3"></i>
                                            <div><div class="info-label">Nacionalitat</div><div class="info-value" th:text="${usuari.nacionalitat ?: '-'}"></div></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <i class="fas fa-check-circle fa-lg me-3"></i>
                                            <div><div class="info-label">Verificat</div>
                                                <div class="info-value">
                                                    <span th:if="${usuari.verified}" class="card-badge badge-green">Sí</span>
                                                    <span th:unless="${usuari.verified}" class="card-badge badge-red">No</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6" th:if="${usuari.createdAt != null}">
                                        <div class="info-item">
                                            <i class="fas fa-calendar fa-lg me-3"></i>
                                            <div><div class="info-label">Registrat</div>
                                                <div class="info-value" th:text="${#temporals.format(usuari.createdAt, 'dd/MM/yyyy')}"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Linked concursant -->
                        <div th:if="${concursant != null}" class="card" style="background-color:var(--card-dark);border:1px solid var(--border-dark);">
                            <div class="card-body p-4">
                                <h3 class="mb-3">Concursant Vinculat</h3>
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <div style="font-weight:700;color:var(--text-light);" th:text="${concursant.nom + ' ' + concursant.cognom}"></div>
                                        <span class="card-badge badge-blue mt-1 d-inline-block" th:text="${concursant.categoria ?: '-'}"></span>
                                    </div>
                                    <a th:href="@{'/concursants/' + ${concursant.id}}" class="btn btn-secondary">
                                        <i class="fas fa-eye me-1"></i> Veure
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
</body>
</html>
<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDni = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const path = window.location.pathname;
            const match = path.match(/\/usuaris\/(.+)/);

            if (match) {
                currentDni = decodeURIComponent(match[1]);
                await carregarUsuari(currentDni);
            }
        });

        async function carregarUsuari(dni) {
            try {
                const response = await fetch(`/usuaris/api/${dni}`);
                if (response.ok) {
                    const usuari = await response.json();

                    document.getElementById('dni').textContent = usuari.dni;
                    document.getElementById('nom').textContent = usuari.nom;
                    document.getElementById('telefon').textContent = usuari.telefon || '';
                    document.getElementById('correu').textContent = usuari.correu || '';
                    document.getElementById('token').textContent = usuari.token;

                    document.getElementById('editarBtn').href = `/usuaris/editar/${usuari.dni}`;

                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('usuariDetall').style.display = 'block';
                } else {
                    mostrarAlerta('Usuari no trobat', 'danger');
                    setTimeout(() => window.location.href = '/usuaris', 2000);
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al carregar l\'usuari', 'danger');
            }
        }

        document.getElementById('eliminarBtn').addEventListener('click', async () => {
            if (!confirm('Estàs segur que vols eliminar aquest usuari?')) {
                return;
            }

            try {
                const response = await fetch(`/usuaris/api/${currentDni}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    mostrarAlerta('Usuari eliminat correctament', 'success');
                    setTimeout(() => window.location.href = '/usuaris', 1500);
                } else {
                    mostrarAlerta('Error al eliminar l\'usuari', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al eliminar l\'usuari', 'danger');
            }
        });

        function mostrarAlerta(missatge, tipus) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipus} alert-dismissible fade show`;
            alert.innerHTML = `${missatge}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            alertContainer.appendChild(alert);
        }
    </script>
</body>
</html>
